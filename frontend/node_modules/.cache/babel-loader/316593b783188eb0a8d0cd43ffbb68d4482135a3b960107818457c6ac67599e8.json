{"ast":null,"code":"import React,{createContext,useContext,useEffect,useState}from'react';import{useNavigate}from'react-router-dom';import toast from'react-hot-toast';import{authAPI}from'../services/api';import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(undefined);export const useAuth=()=>{const context=useContext(AuthContext);if(!context){throw new Error('useAuth must be used within an AuthProvider');}return context;};export const AuthProvider=_ref=>{let{children}=_ref;const[user,setUser]=useState(null);const[token,setToken]=useState(null);const[isLoading,setIsLoading]=useState(true);const navigate=useNavigate();const isAuthenticated=!!user&&!!token;useEffect(()=>{// Проверяем токен в localStorage при инициализации\nconst savedToken=localStorage.getItem('auth_token');if(savedToken){setToken(savedToken);loadUser(savedToken);}else{setIsLoading(false);}},[]);const loadUser=async authToken=>{try{const response=await authAPI.getCurrentUser(authToken);if(response.success){setUser(response.data);}else{throw new Error(response.error||'Не удалось загрузить пользователя');}}catch(error){console.error('Load user error:',error);logout();}finally{setIsLoading(false);}};const login=async(email,password)=>{try{setIsLoading(true);const response=await authAPI.login(email,password);if(response.success){const{token:authToken,user:userData}=response.data;setToken(authToken);setUser(userData);localStorage.setItem('auth_token',authToken);toast.success('Добро пожаловать!');navigate('/dashboard');}else{throw new Error(response.error||'Ошибка авторизации');}}catch(error){console.error('Login error:',error);toast.error(error.message||'Ошибка авторизации');throw error;}finally{setIsLoading(false);}};const register=async userData=>{try{setIsLoading(true);const response=await authAPI.register(userData);if(response.success){toast.success('Регистрация успешна! Пароль отправлен в Mattermost.');navigate('/login');}else{throw new Error(response.error||'Ошибка регистрации');}}catch(error){console.error('Registration error:',error);toast.error(error.message||'Ошибка регистрации');throw error;}finally{setIsLoading(false);}};const logout=()=>{setUser(null);setToken(null);localStorage.removeItem('auth_token');toast.success('Вы вышли из системы');navigate('/login');};const value={user,token,login,logout,register,isLoading,isAuthenticated};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:value,children:children});};","map":{"version":3,"names":["React","createContext","useContext","useEffect","useState","useNavigate","toast","authAPI","jsx","_jsx","AuthContext","undefined","useAuth","context","Error","AuthProvider","_ref","children","user","setUser","token","setToken","isLoading","setIsLoading","navigate","isAuthenticated","savedToken","localStorage","getItem","loadUser","authToken","response","getCurrentUser","success","data","error","console","logout","login","email","password","userData","setItem","message","register","removeItem","value","Provider"],"sources":["/Users/chastnik/Documents/projects/360/frontend/src/contexts/AuthContext.tsx"],"sourcesContent":["import React, { createContext, useContext, useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport toast from 'react-hot-toast';\nimport { authAPI } from '../services/api';\n\ninterface User {\n  id: string;\n  email: string;\n  first_name: string;\n  last_name: string;\n  middle_name?: string;\n  role: 'admin' | 'manager' | 'user';\n  position?: string;\n  department?: string;\n  manager_id?: string;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  token: string | null;\n  login: (email: string, password: string) => Promise<void>;\n  logout: () => void;\n  register: (userData: RegisterData) => Promise<void>;\n  isLoading: boolean;\n  isAuthenticated: boolean;\n}\n\ninterface RegisterData {\n  email: string;\n  first_name: string;\n  last_name: string;\n  middle_name?: string;\n  mattermost_username?: string;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport const useAuth = () => {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n};\n\ninterface AuthProviderProps {\n  children: React.ReactNode;\n}\n\nexport const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {\n  const [user, setUser] = useState<User | null>(null);\n  const [token, setToken] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const navigate = useNavigate();\n\n  const isAuthenticated = !!user && !!token;\n\n  useEffect(() => {\n    // Проверяем токен в localStorage при инициализации\n    const savedToken = localStorage.getItem('auth_token');\n    if (savedToken) {\n      setToken(savedToken);\n      loadUser(savedToken);\n    } else {\n      setIsLoading(false);\n    }\n  }, []);\n\n  const loadUser = async (authToken: string) => {\n    try {\n      const response = await authAPI.getCurrentUser(authToken);\n      if (response.success) {\n        setUser(response.data);\n      } else {\n        throw new Error(response.error || 'Не удалось загрузить пользователя');\n      }\n    } catch (error) {\n      console.error('Load user error:', error);\n      logout();\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const login = async (email: string, password: string) => {\n    try {\n      setIsLoading(true);\n      const response = await authAPI.login(email, password);\n      \n      if (response.success) {\n        const { token: authToken, user: userData } = response.data;\n        setToken(authToken);\n        setUser(userData);\n        localStorage.setItem('auth_token', authToken);\n        \n        toast.success('Добро пожаловать!');\n        navigate('/dashboard');\n      } else {\n        throw new Error(response.error || 'Ошибка авторизации');\n      }\n    } catch (error: any) {\n      console.error('Login error:', error);\n      toast.error(error.message || 'Ошибка авторизации');\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const register = async (userData: RegisterData) => {\n    try {\n      setIsLoading(true);\n      const response = await authAPI.register(userData);\n      \n      if (response.success) {\n        toast.success('Регистрация успешна! Пароль отправлен в Mattermost.');\n        navigate('/login');\n      } else {\n        throw new Error(response.error || 'Ошибка регистрации');\n      }\n    } catch (error: any) {\n      console.error('Registration error:', error);\n      toast.error(error.message || 'Ошибка регистрации');\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const logout = () => {\n    setUser(null);\n    setToken(null);\n    localStorage.removeItem('auth_token');\n    toast.success('Вы вышли из системы');\n    navigate('/login');\n  };\n\n  const value = {\n    user,\n    token,\n    login,\n    logout,\n    register,\n    isLoading,\n    isAuthenticated,\n  };\n\n  return (\n    <AuthContext.Provider value={value}>\n      {children}\n    </AuthContext.Provider>\n  );\n}; "],"mappings":"AAAA,MAAO,CAAAA,KAAK,EAAIC,aAAa,CAAEC,UAAU,CAAEC,SAAS,CAAEC,QAAQ,KAAQ,OAAO,CAC7E,OAASC,WAAW,KAAQ,kBAAkB,CAC9C,MAAO,CAAAC,KAAK,KAAM,iBAAiB,CACnC,OAASC,OAAO,KAAQ,iBAAiB,CAAC,OAAAC,GAAA,IAAAC,IAAA,yBAgC1C,KAAM,CAAAC,WAAW,cAAGT,aAAa,CAA8BU,SAAS,CAAC,CAEzE,MAAO,MAAM,CAAAC,OAAO,CAAGA,CAAA,GAAM,CAC3B,KAAM,CAAAC,OAAO,CAAGX,UAAU,CAACQ,WAAW,CAAC,CACvC,GAAI,CAACG,OAAO,CAAE,CACZ,KAAM,IAAI,CAAAC,KAAK,CAAC,6CAA6C,CAAC,CAChE,CACA,MAAO,CAAAD,OAAO,CAChB,CAAC,CAMD,MAAO,MAAM,CAAAE,YAAyC,CAAGC,IAAA,EAAkB,IAAjB,CAAEC,QAAS,CAAC,CAAAD,IAAA,CACpE,KAAM,CAACE,IAAI,CAAEC,OAAO,CAAC,CAAGf,QAAQ,CAAc,IAAI,CAAC,CACnD,KAAM,CAACgB,KAAK,CAAEC,QAAQ,CAAC,CAAGjB,QAAQ,CAAgB,IAAI,CAAC,CACvD,KAAM,CAACkB,SAAS,CAAEC,YAAY,CAAC,CAAGnB,QAAQ,CAAC,IAAI,CAAC,CAChD,KAAM,CAAAoB,QAAQ,CAAGnB,WAAW,CAAC,CAAC,CAE9B,KAAM,CAAAoB,eAAe,CAAG,CAAC,CAACP,IAAI,EAAI,CAAC,CAACE,KAAK,CAEzCjB,SAAS,CAAC,IAAM,CACd;AACA,KAAM,CAAAuB,UAAU,CAAGC,YAAY,CAACC,OAAO,CAAC,YAAY,CAAC,CACrD,GAAIF,UAAU,CAAE,CACdL,QAAQ,CAACK,UAAU,CAAC,CACpBG,QAAQ,CAACH,UAAU,CAAC,CACtB,CAAC,IAAM,CACLH,YAAY,CAAC,KAAK,CAAC,CACrB,CACF,CAAC,CAAE,EAAE,CAAC,CAEN,KAAM,CAAAM,QAAQ,CAAG,KAAO,CAAAC,SAAiB,EAAK,CAC5C,GAAI,CACF,KAAM,CAAAC,QAAQ,CAAG,KAAM,CAAAxB,OAAO,CAACyB,cAAc,CAACF,SAAS,CAAC,CACxD,GAAIC,QAAQ,CAACE,OAAO,CAAE,CACpBd,OAAO,CAACY,QAAQ,CAACG,IAAI,CAAC,CACxB,CAAC,IAAM,CACL,KAAM,IAAI,CAAApB,KAAK,CAACiB,QAAQ,CAACI,KAAK,EAAI,mCAAmC,CAAC,CACxE,CACF,CAAE,MAAOA,KAAK,CAAE,CACdC,OAAO,CAACD,KAAK,CAAC,kBAAkB,CAAEA,KAAK,CAAC,CACxCE,MAAM,CAAC,CAAC,CACV,CAAC,OAAS,CACRd,YAAY,CAAC,KAAK,CAAC,CACrB,CACF,CAAC,CAED,KAAM,CAAAe,KAAK,CAAG,KAAAA,CAAOC,KAAa,CAAEC,QAAgB,GAAK,CACvD,GAAI,CACFjB,YAAY,CAAC,IAAI,CAAC,CAClB,KAAM,CAAAQ,QAAQ,CAAG,KAAM,CAAAxB,OAAO,CAAC+B,KAAK,CAACC,KAAK,CAAEC,QAAQ,CAAC,CAErD,GAAIT,QAAQ,CAACE,OAAO,CAAE,CACpB,KAAM,CAAEb,KAAK,CAAEU,SAAS,CAAEZ,IAAI,CAAEuB,QAAS,CAAC,CAAGV,QAAQ,CAACG,IAAI,CAC1Db,QAAQ,CAACS,SAAS,CAAC,CACnBX,OAAO,CAACsB,QAAQ,CAAC,CACjBd,YAAY,CAACe,OAAO,CAAC,YAAY,CAAEZ,SAAS,CAAC,CAE7CxB,KAAK,CAAC2B,OAAO,CAAC,mBAAmB,CAAC,CAClCT,QAAQ,CAAC,YAAY,CAAC,CACxB,CAAC,IAAM,CACL,KAAM,IAAI,CAAAV,KAAK,CAACiB,QAAQ,CAACI,KAAK,EAAI,oBAAoB,CAAC,CACzD,CACF,CAAE,MAAOA,KAAU,CAAE,CACnBC,OAAO,CAACD,KAAK,CAAC,cAAc,CAAEA,KAAK,CAAC,CACpC7B,KAAK,CAAC6B,KAAK,CAACA,KAAK,CAACQ,OAAO,EAAI,oBAAoB,CAAC,CAClD,KAAM,CAAAR,KAAK,CACb,CAAC,OAAS,CACRZ,YAAY,CAAC,KAAK,CAAC,CACrB,CACF,CAAC,CAED,KAAM,CAAAqB,QAAQ,CAAG,KAAO,CAAAH,QAAsB,EAAK,CACjD,GAAI,CACFlB,YAAY,CAAC,IAAI,CAAC,CAClB,KAAM,CAAAQ,QAAQ,CAAG,KAAM,CAAAxB,OAAO,CAACqC,QAAQ,CAACH,QAAQ,CAAC,CAEjD,GAAIV,QAAQ,CAACE,OAAO,CAAE,CACpB3B,KAAK,CAAC2B,OAAO,CAAC,qDAAqD,CAAC,CACpET,QAAQ,CAAC,QAAQ,CAAC,CACpB,CAAC,IAAM,CACL,KAAM,IAAI,CAAAV,KAAK,CAACiB,QAAQ,CAACI,KAAK,EAAI,oBAAoB,CAAC,CACzD,CACF,CAAE,MAAOA,KAAU,CAAE,CACnBC,OAAO,CAACD,KAAK,CAAC,qBAAqB,CAAEA,KAAK,CAAC,CAC3C7B,KAAK,CAAC6B,KAAK,CAACA,KAAK,CAACQ,OAAO,EAAI,oBAAoB,CAAC,CAClD,KAAM,CAAAR,KAAK,CACb,CAAC,OAAS,CACRZ,YAAY,CAAC,KAAK,CAAC,CACrB,CACF,CAAC,CAED,KAAM,CAAAc,MAAM,CAAGA,CAAA,GAAM,CACnBlB,OAAO,CAAC,IAAI,CAAC,CACbE,QAAQ,CAAC,IAAI,CAAC,CACdM,YAAY,CAACkB,UAAU,CAAC,YAAY,CAAC,CACrCvC,KAAK,CAAC2B,OAAO,CAAC,qBAAqB,CAAC,CACpCT,QAAQ,CAAC,QAAQ,CAAC,CACpB,CAAC,CAED,KAAM,CAAAsB,KAAK,CAAG,CACZ5B,IAAI,CACJE,KAAK,CACLkB,KAAK,CACLD,MAAM,CACNO,QAAQ,CACRtB,SAAS,CACTG,eACF,CAAC,CAED,mBACEhB,IAAA,CAACC,WAAW,CAACqC,QAAQ,EAACD,KAAK,CAAEA,KAAM,CAAA7B,QAAA,CAChCA,QAAQ,CACW,CAAC,CAE3B,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}