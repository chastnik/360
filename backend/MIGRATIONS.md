# Миграции базы данных

© 2025 Бит.Цифра - Стас Чашин

## Обзор

Этот документ описывает все миграции базы данных для системы 360-градусной оценки персонала.

## Выполнение миграций

### Автоматическое развертывание

Используйте скрипт для автоматического развертывания всех миграций:

```bash
cd backend
./scripts/deploy-migrations.sh
```

С сидами (начальными данными):

```bash
./scripts/deploy-migrations.sh --with-seeds
```

### Ручное выполнение

```bash
cd backend
npm run migrate
```

### Выполнение сидов

```bash
cd backend
npm run seed
```

## Список миграций

Всего миграций: **28**

### Базовые таблицы (2024-01-01)

1. **20240101000001_create_users_table.js**
   - Создание таблицы пользователей

2. **20240101000002_create_categories_table.js**
   - Создание таблицы категорий оценки

3. **20240101000003_create_questions_table.js**
   - Создание таблицы вопросов

4. **20240101000004_create_assessment_cycles_table.js**
   - Создание таблицы циклов оценки

5. **20240101000005_create_assessment_participants_table.js**
   - Создание таблицы участников оценки

6. **20240101000006_create_assessment_respondents_table.js**
   - Создание таблицы респондентов

7. **20240101000007_create_assessment_responses_table.js**
   - Создание таблицы ответов на вопросы

8. **20240101000008_create_assessment_reports_table.js**
   - Создание таблицы отчетов

9. **20240101000009_create_system_settings_table.js**
   - Создание таблицы системных настроек

### Модуль обучения (2025-01-01)

10. **20250101000001_create_learning_tables.js**
    - Создание таблиц для модуля обучения:
      - `training_courses` - курсы обучения
      - `growth_plans` - планы индивидуального роста (ПИР)
      - `test_results` - результаты тестирования
      - `competence_matrix` - матрица компетенций

### Календарь и отпуска (2025-01-15)

11. **20250115120000_create_calendar_tables.js**
    - Создание таблиц календаря:
      - `work_schedules` - рабочие расписания
      - `holidays` - праздничные дни

12. **20250925120000_create_vacations_table.js**
    - Создание таблицы отпусков

### Обновления модуля обучения

13. **20250120000001_remove_test_results_unique_constraint.js**
    - Удаление уникального ограничения на результаты тестов

14. **20250127120000_add_source_to_competence_matrix.js**
    - Добавление поля `source` в матрицу компетенций (training/manual)

15. **20250130000001_recalculate_vacation_days_to_calendar.js**
    - Пересчет дней отпуска с учетом календаря

### Пользователи и профили

16. **20250201000000_add_resume_to_users.js**
    - Добавление поля `resume` (резюме) в таблицу пользователей

17. **20250807070740_add_hr_role.js**
    - Добавление роли HR в систему

18. **20250807071420_create_departments_table.js**
    - Создание таблицы отделов

19. **20250807071431_update_users_department_relation.js**
    - Обновление связи пользователей с отделами (добавление `department_id`)

20. **20250807125944_add_is_manager_field_to_users.js**
    - Добавление поля `is_manager` в таблицу пользователей

21. **20250807171323_add_completed_notification_sent_to_participants.js**
    - Добавление поля `completed_notification_sent` в таблицу участников

22. **20250807180000_add_password_reset_fields.js**
    - Добавление полей для сброса пароля

### Система ролей и прав

23. **20250808120000_create_roles_tables.js**
    - Создание таблиц системы ролей:
      - `roles` - роли
      - `permissions` - права доступа
      - `role_permissions` - связь ролей и прав

24. **20250808120500_add_role_id_to_users.js**
    - Добавление поля `role_id` в таблицу пользователей

### Аватары пользователей

25. **20250809090000_add_avatar_url_to_users.js**
    - Добавление поля `avatar_url` в таблицу пользователей

26. **20250809091000_add_avatar_blob_to_users.js**
    - Добавление полей для хранения аватаров в БД:
      - `avatar_data` - бинарные данные
      - `avatar_mime` - MIME тип
      - `avatar_updated_at` - дата обновления

### Компетенции

27. **20250809100000_create_competencies_table.js**
    - Создание таблицы компетенций

28. **20250918120000_update_competence_levels.js**
    - Обновление уровней компетенций (junior/middle/senior)

29. **20250926120000_add_competency_id_to_training_courses.js**
    - Добавление связи курсов с компетенциями

## Порядок выполнения

Миграции выполняются автоматически в хронологическом порядке по дате в имени файла.

## Откат миграций

Для отката последней миграции:

```bash
cd backend
npx knex migrate:rollback
```

Для отката всех миграций:

```bash
npx knex migrate:rollback --all
```

## Проверка статуса миграций

Проверить, какие миграции уже выполнены:

```bash
cd backend
npx knex migrate:status
```

## Важные замечания

1. **Резервное копирование**: Перед выполнением миграций на production сервере обязательно создайте резервную копию базы данных.

2. **Порядок выполнения**: Миграции выполняются строго в хронологическом порядке. Не изменяйте порядок миграций.

3. **Идемпотентность**: Большинство миграций проверяют наличие полей/таблиц перед созданием, что делает их безопасными для повторного выполнения.

4. **Сиды**: Сиды (начальные данные) выполняются после миграций и могут быть выполнены несколько раз.

## Устранение проблем

### Ошибка подключения к БД

Убедитесь, что:
- PostgreSQL запущен
- Переменные окружения в `.env` корректны
- База данных существует

### Ошибка выполнения миграции

1. Проверьте логи ошибок
2. Убедитесь, что предыдущие миграции выполнены успешно
3. Проверьте, что база данных не заблокирована другими процессами

### Миграция уже выполнена

Если миграция уже была выполнена, но запись в `knex_migrations` отсутствует, можно вручную добавить запись:

```sql
INSERT INTO knex_migrations (name, batch) 
VALUES ('20250201000000_add_resume_to_users.js', <номер_батча>);
```

## Контакты

При возникновении проблем обращайтесь к разработчику: Стас Чашин @chastnik

